

p = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF
a = -3
b = 0x5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B

import random
import socket

def recv_until_newline(sock):

    data = b""
    while True:
        chunk = sock.recv(1)  
        if not chunk:
            break  
        data += chunk
        if b'\n' in chunk:
            break 
    return data.decode()

E = EllipticCurve(GF(p), [a, b])

def random_curve(E):
    b_prime = random.randint(1,p)
    E_prime = EllipticCurve(GF(p), [a, b_prime])
    return E_prime, b_prime

def count_points_on_curve(E_prime):
    n_prime = E_prime.cardinality()
    return n_prime

def find_small_factors(n_prime, used_factors):
    factors = factor(n_prime)  
    small_factors = [f[0] for f in factors if f[0] < 10000 and f[0] not in used_factors]  
    return small_factors

def find_low_order_point(E_prime, n_prime, q):
    while True:
        H = E_prime.random_point()  
        R = (n_prime // q) * H 
        if R.order() == q:  
            print(f"Point R found with order {q}:")
            print(R)
            print(f"{hex(R[0])[2:]}:{hex(R[1])[2:]}")
            return R

def main():
    print(f"Using the base curve P-256: {E}")

    
    used_factors = set([2,3,5])  
    
    primes = []
    dlogs = []

    while True:
        E_prime, b_prime = random_curve(E)
        print(f"Generated random curve E': y^2 = x^3 + {a}x + {b_prime}")
        
        n_prime = count_points_on_curve(E_prime)
        print(f"n' (number of points on E'): {n_prime}")
        
        small_factors = find_small_factors(n_prime, used_factors)
        if not small_factors:
            print("No unused small factors found. Trying another curve...")
            continue  
        q = small_factors[0]
        print(f"Small factor found: q = {q}")
        

        
        R = find_low_order_point(E_prime, n_prime, q)

        

        try:
            client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            server_address = ('127.0.0.1', 4444) 
            client_socket.connect(server_address)

            recv_until_newline(client_socket)
            sleep(1)
            message = f"{hex(R[0])[2:]}:{hex(R[1])[2:]}"
            client_socket.send(message.encode())
            sleep(1)
            scalarX = Integer(recv_until_newline(client_socket))

            client_socket.close()

            S_arr = E_prime.lift_x(scalarX, all=True)
            for S in S_arr:
                try:
                    k = R.discrete_log(S)
                    print(f"k: {k}, q: {q}")
                    used_factors.add(q)
                except:
                    print('bad')
            
            
            #primes.append(q)
            #dlogs.append(k)
            
            #print(primes)
            #print(dlogs)
            #key  = CRT_list(dlogs, primes)

            #print(hex(key))
            
        except:
            print('Oh no')



main()
